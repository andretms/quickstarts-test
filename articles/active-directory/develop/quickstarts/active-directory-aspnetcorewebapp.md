---
title: Azure AD v2 ASP.NET Core web app Quickstart | Microsoft Docs
description: Implementing Microsoft Sign-In on an ASP.NET core with a traditional web browser based application using OpenID Connect
services: active-directory
documentationcenter: dev-center-name
author: andretms
manager: mtillman
editor: ''

ms.assetid: 820acdb7-d316-4c3b-8de9-79df48ba3b06
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 05/10/2018
ms.author: andret
ms.custom: aaddev 

---

# Add sign-in with Microsoft to an ASP.NET Core web app

This quickstart contains a code sample that demonstrates how an ASP.NET Core Web App can sign in personal (hotmail.com, live.com, others) and work and school accounts from any Azure Active Directory instance.

![How the sample app generated by this guide works](media/active-directory-aspnetwebapp/aspnetbrowsergeneral.png)
(Update graphics)

> [!div renderon="docs"]
> ## Step 1: Register your application in Azure portal
> 
> 1. To register an application, go to the [Azure AD - Application Registration](https://portal.azure.com/signin/index/?Microsoft_AAD_RegisteredApps=true#blade/Microsoft_AAD_RegisteredApps/applicationsListBlade/quickStartType/AspNetWebAppQuickstartPage/sourceType/docs)
> 1. Enter a name for your application and click **Create**
> 1. Follow the steps to add *https:<span/>//localhost:5000/* as redirect URL

> [!div class="sxs-lookup" renderon="portal"]
> ## Step 1: Configure your application
> For the code sample for this quickstart to work, you need to add a reply URL to *https:<span/>//localhost:5000/* as redirect URL.
> > [!div id="makechanges" class="hidden"]
> > [Make these changes for me]()
>
> > [!div id="appconfigured" class="hidden"]
> > ![Already configured](media/active-directory-windesktop/checkmark.png) Your application is configured with these attributes

## Step 2: Download your web server or project

- [Download the Visual Studio 2017 project](https://github.com/AzureADQuickStarts/AppModelv2-WebApp-OpenIDConnect-DotNet/archive/master.zip)

## Step 3: Configure your project

1. If you use Visual Studio 2017, open the project in Visual Studio (optional)
1. Edit **appsettings.json** and replace add the Application ID from the application you just registered:

    ```json
    "ClientId": "[Enter the Client Id (Application ID obtained from the Azure portal), e.g. ba74781c2-53c2-442a-97c2-3d60re42f403]"
    "TenantId": "common"
    ```

## More information

### Startup Class

Microsoft.AspNetCore.Authentication Middleware uses a Startup class that is executed when the hosting process initializes:

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddAuthentication(sharedOptions =>
    {
        sharedOptions.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
        sharedOptions.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
    })
    .AddAzureAd(options => Configuration.Bind("AzureAd", options))
    .AddCookie();

    services.AddMvc();
}
```

The method `AddAuthentication` configures the service to add Cookie-based authentication - used on browser scenarios, as well as set the challenge to OpenIdConnect. 

The line containing `.AddAzureAd` adds the Azure Active Directory Authentication to your application.

Besides that, the file **AzureAdAuthenticationBuilderExtensions.cs** adds extension method to AzureAd Authentication pipeline. This extension method configure the attributes needed for Azure AD Authentication. The `Configure` method in `IConfigureNamedOptions` interface contains the following:

```csharp
public void Configure(string name, OpenIdConnectOptions options)
{
    options.ClientId = _azureOptions.ClientId;
    options.Authority = $"{_azureOptions.Instance}common/v2.0";   // V2 specific
    options.UseTokenLifetime = true;
    options.RequireHttpsMetadata = false;
    options.TokenValidationParameters.ValidateIssuer = false;     // accept several tenants
}
```
> |Where  |  |
> |---------|---------|
> |ClientId     |Application Id from the application registered in the Azure Portal|
> |Authority | The STS endpoint fo user to authenticate. Usually https://login.microsoftonline.com/{tenant}/v2.0 for public cloud, where {tenant} is the name of your tenant, your tenant Id, or *common* for a reference to the common endpoint (used for multi-tenant applications)|
> |UseTokenLifetime |Indicates that the authentication cookie should match that of the authentication token|
> |RequireHttpsMetadata     |Require HTTPS for the metadata address or authority. It is recommended to change this value to `True`|
> |TokenValidationParameters     | A list of parameters for token validation. In this case, `ValidateIssuer` is set to `false` to indicate that it can accept sign-ins from any personal, or work or school accounts|

### Initiate an authentication challenge

You can force user to sign in by requesting an authentication challenge in your controller just like in **AccountController.cs**:

```csharp
public IActionResult SignIn()
{
    var redirectUrl = Url.Action(nameof(HomeController.Index), "Home");
    return Challenge(
        new AuthenticationProperties { RedirectUri = redirectUrl },
        OpenIdConnectDefaults.AuthenticationScheme);
}
```

> [!TIP]
> Requesting an authentication challenge using the method above is optional and commonsly used when you want a view to be available for both authenticated and non-authenticated users. You can protect controllers by using the method described in the next section.

### Protect a controller or a controller's method

You can protect a controller or controller methodss using the `[Authorize]` attribute. This attribute restricts access to the controller or methods by only allowing authenticated users - which means that authentication challenge can be started to access the controller if user is not authenticated.

## What is next

Check out the GitHub repo for this ASP.NET Core Quickstart for more information - including instructions on how to add authentication to a brand new ASP.NET Core Web application:

> [!div class="nextstepaction"]
> [ASP.NET Core Web App Code Sample](https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2)

[!INCLUDE [Help and support](../../../../includes/active-directory-develop-help-support-include.md)]